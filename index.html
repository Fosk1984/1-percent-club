<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The 1% Club ‚Äî Clinical MSK Edition (Multiplayer)</title>
  <meta name="description" content="Multiplayer 1% Club style quiz for clinical MSK (non‚Äëultrasound). Single‚Äëfile GitHub Pages app with optional Firebase sync." />
  <link rel="icon" href="data:,"><!-- silence favicon 404 on GitHub Pages -->
  <style>
    :root{
      --bg:#0b0f1a; --card:#12172a; --ink:#eaf0ff; --muted:#9aa4bf;
      --acc:#6ac2ff; --acc2:#ffd36a; --ok:#33d17a; --bad:#ff6b6b; --edge:#26315a;
      --glow:0 10px 40px rgba(106,194,255,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink); background:
        radial-gradient(1200px 800px at 20% -10%, #142043 0%, #0f1730 40%, var(--bg) 100%) fixed;
      line-height:1.35;
    }
    .wrap{display:grid; grid-template-rows:auto 1fr; min-height:100vh}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 18px; border-bottom:1px solid var(--edge); background:rgba(18,23,42,.6);
      backdrop-filter: blur(8px);
    }
    h1{margin:0; font-size:clamp(18px, 2.2vw, 28px); letter-spacing:.3px}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .roleTabs{display:flex; gap:6px; background:#0e1430; border:1px solid var(--edge); border-radius:12px; padding:4px}
    .roleTabs button{appearance:none; border:none; background:transparent; color:var(--ink); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700}
    .roleTabs button.active{background:#0b132d; outline:2px solid rgba(106,194,255,.25)}
    button, .chip{
      appearance:none; border:1px solid var(--edge); background:#0e1430; color:var(--ink);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:var(--glow);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{transform:translateY(-1px); border-color:var(--acc)}
    button:disabled{opacity:.5; cursor:not-allowed}
    .chip{font-size:13px; user-select:none}

    .main{display:grid; grid-template-columns:280px 1fr 340px; gap:16px; padding:16px}
    @media (max-width:1100px){ .main{grid-template-columns:1fr; grid-auto-rows:min-content} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0));
      border:1px solid var(--edge); border-radius:18px; padding:16px; box-shadow:var(--glow)
    }
    .titleRow{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .ladder{display:flex; flex-direction:column; gap:8px}
    .ladder .step{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px;
      border-radius:12px; border:1px solid var(--edge); background:#0e1430}
    .ladder .step.current{border-color:var(--acc); outline:2px solid rgba(106,194,255,.25)}
    .ladder .step.done{opacity:.75}
    .pct{font-weight:800}

    .qbox{display:flex; flex-direction:column; gap:14px}
    .qtext{font-size:clamp(18px, 2.1vw, 24px)}
    .opts{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:600px){ .opts{grid-template-columns:1fr} }

    .opt{display:flex; align-items:center; gap:10px; padding:14px; border-radius:14px; border:1px solid var(--edge);
      background:#0b132d; text-align:left; font-weight:600}
    .opt .k{width:28px; height:28px; display:inline-grid; place-items:center; border-radius:8px; background:#0a1027;
      border:1px solid var(--edge); font-weight:800}
    .opt.selected{border-color:var(--acc); outline:2px solid rgba(106,194,255,.25)}
    .opt.correct{border-color:var(--ok); background:rgba(51,209,122,.08)}
    .opt.wrong{border-color:var(--bad); background:rgba(255,107,107,.08)}

    .hostRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .note{font-size:15px; color:var(--muted); border-top:1px dashed var(--edge); padding-top:10px}

    .roster h3{margin:0 0 8px 0}
    .row{display:grid; grid-template-columns:1fr auto auto auto; gap:8px; align-items:center}
    .pill{padding:6px 10px; border:1px solid var(--edge); border-radius:999px; font-weight:700; font-size:12px}
    .pill.ok{border-color:var(--ok)}
    .pill.bad{border-color:var(--bad)}
    .small{font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .spacer{flex:1}
    .kb{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px; background:#0c1330; border:1px solid var(--edge); padding:2px 6px; border-radius:8px}
    .hint{font-size:12px; color:#b3bedb}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .grid2{grid-template-columns:1fr} }

    .hist{display:grid; grid-template-columns:1fr; gap:6px; margin-top:8px}
    .bar{display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center}
    .bar .track{height:10px; border-radius:999px; background:#0a1027; border:1px solid var(--edge); overflow:hidden}
    .bar .fill{height:100%; background:linear-gradient(90deg, var(--acc), #7ad1ff)}

    .statusStrip{display:flex; gap:8px; align-items:center}
    .ghost{opacity:.6}
    .linkBox{display:flex; gap:8px; align-items:center}
    input[type="text"], input[type="search"]{padding:10px;border-radius:10px;border:1px solid var(--edge);background:#0e1430;color:var(--ink)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üß† The 1% Club ‚Äî Clinical MSK Edition <span class="small muted">(multiplayer ¬∑ no ultrasound)</span></h1>
    <div class="controls">
      <div class="roleTabs" role="tablist" aria-label="Mode">
        <button id="tabLocal" class="active" role="tab" aria-selected="true">Local</button>
        <button id="tabHost" role="tab" aria-selected="false">Host</button>
        <button id="tabPlayer" role="tab" aria-selected="false">Player</button>
      </div>
      <span class="chip" id="cloudChip">‚òÅÔ∏è Cloud: Off</span>
      <span class="chip" id="soundChip">üîà Sound: Off</span>
    </div>
  </header>

  <main class="main">
    <!-- Ladder -->
    <section class="card">
      <div class="titleRow"><h2 style="margin:0">Question Ladder</h2><span class="small">Higher = easier</span></div>
      <div id="ladder" class="ladder" aria-live="polite"></div>
    </section>

    <!-- Question card -->
    <section class="card">
      <div class="qbox">
        <div class="statusStrip">
          <div id="qPct" class="pill ok">‚Äî%</div>
          <div id="roomBadge" class="pill ghost" hidden>Room: ‚Äî</div>
          <div id="roleBadge" class="pill ghost">Local</div>
        </div>
        <div id="qText" class="qtext" style="margin-top:8px">Choose a mode above. In <b>Local</b>, press <b>Start Game</b>.
          In <b>Host</b>/<b>Player</b>, connect with a room code.</div>
        <div id="opts" class="opts" aria-label="Answer options"></div>

        <!-- Local/Host controls under the question -->
        <div class="hostRow">
          <button id="startBtn">Start Game</button>
          <button id="lockBtn" disabled>Lock In</button>
          <button id="revealBtn" disabled>Reveal Answer <span class="kb">R</span></button>
          <button id="nextBtn" disabled>Next <span class="kb">N</span></button>
          <span class="muted">Shortcuts: <span class="kb">A‚ÄìD</span> select, <span class="kb">R</span> reveal, <span class="kb">N</span> next</span>
          <span class="spacer"></span>
          <span id="status" class="small"></span>
        </div>
        <div id="note" class="note" hidden></div>

        <!-- Multiplayer join/create UI -->
        <div class="grid2" style="margin-top:14px" id="mpanel">
          <!-- Host panel -->
          <div id="hostPanel" hidden>
            <div class="titleRow"><h3 style="margin:0">Host Controls</h3></div>
            <div class="row" style="grid-template-columns:1fr auto auto; margin-top:8px">
              <input id="hostNameInput" placeholder="(Optional) Host display name" />
              <button id="createRoomBtn">Create Room</button>
              <button id="closeRoomBtn" disabled>Close Room</button>
            </div>
            <div id="roomInfo" class="linkBox" style="margin-top:8px" hidden>
              <span class="pill ok" id="roomCode">CODE</span>
              <input id="shareLink" type="text" readonly />
              <button id="copyLinkBtn">Copy Link</button>
            </div>
            <div id="counts" class="hist" style="margin-top:10px" hidden>
              <div class="bar"><span class="pill">A</span><div class="track"><div class="fill" id="fa" style="width:0%"></div></div><span id="ca" class="small">0</span></div>
              <div class="bar"><span class="pill">B</span><div class="track"><div class="fill" id="fb" style="width:0%"></div></div><span id="cb" class="small">0</span></div>
              <div class="bar"><span class="pill">C</span><div class="track"><div class="fill" id="fc" style="width:0%"></div></div><span id="cc" class="small">0</span></div>
              <div class="bar"><span class="pill">D</span><div class="track"><div class="fill" id="fd" style="width:0%"></div></div><span id="cd" class="small">0</span></div>
            </div>
            <p class="hint" id="hostHint">Create a room, then share the link/code. Players join and you control Reveal/Next. Live answer counts will appear here.</p>
          </div>

          <!-- Player panel -->
          <div id="playerPanel" hidden>
            <div class="titleRow"><h3 style="margin:0">Join a Room</h3></div>
            <div class="row" style="grid-template-columns:1fr 1fr auto; margin-top:8px">
              <input id="playerName" placeholder="Your name" />
              <input id="joinCode" placeholder="Room code" />
              <button id="joinBtn">Join</button>
            </div>
            <p class="hint" id="playerHint">After joining, select your answer on each question. You can change it until the host reveals.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Roster / Host tools -->
    <aside class="card roster">
      <div class="titleRow"><h3>Players <span id="pCount" class="small muted"></span></h3>
        <button id="clearRosterBtn">Clear</button></div>
      <div class="row" style="margin:8px 0 12px 0">
        <input id="nameInput" placeholder="Add names (comma‚Äëseparated)‚Ä¶" aria-label="Add players">
        <button id="addBtn">Add</button>
        <button id="allPassBtn">Give Everyone a Pass</button>
        <button id="reviveBtn">Revive All</button>
      </div>
      <div id="roster"></div>
      <p class="small muted" style="margin-top:10px">Local mode: roster is saved in your browser.<br>Cloud mode: roster syncs to the room.</p>
    </aside>
  </main>
</div>

<!-- Optional Firebase (fill config to enable cloud sync). Keep these 3 lines; they‚Äôre safe if unused. -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script>
'use strict';

/******************** Firebase bootstrap (optional) ********************/
// 1) Fill your config below. If left as-is, cloud sync stays Off and Local mode works normally.
const FB_CONFIG = {
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    apiKey: "AIzaSyAAlHBdemzktDB25HozuliuL6BWcYZ7hUg",
    authDomain: "percent-club-76c05.firebaseapp.com",
    projectId: "percent-club-76c05",
    storageBucket: "percent-club-76c05.firebasestorage.app",
    messagingSenderId: "87140817040",
    appId: "1:87140817040:web:5ff5bae0a42c999097a015",
    measurementId: "G-G7FMP4XBFN"
  };
// Accept either FB_CONFIG or firebaseConfig to be forgiving
const _CFG = window.FB_CONFIG || window.firebaseConfig;

let firebaseReady = false, db = null, myUid = null;

(function safeInitFirebase(){
  try {
    if (!_CFG || !_CFG.apiKey) throw new Error('Missing Firebase config');

    // Idempotent init (won't throw if already initialised)
    if (!firebase.apps.length) {
      firebase.initializeApp(_CFG);
    }

    db = firebase.firestore();

    // Anonymous auth (non-blocking)
    firebase.auth().signInAnonymously().catch(console.warn);
    firebase.auth().onAuthStateChanged(u => { myUid = u ? u.uid : null; });

    firebaseReady = true;
    // (Optional) if you have a chip element:
    const cloudChip = document.getElementById('cloudChip');
    if (cloudChip) cloudChip.textContent = '‚òÅÔ∏è Cloud: On';
  } catch (e) {
    console.error('Firebase init failed:', e);
    firebaseReady = false;
    const cloudChip = document.getElementById('cloudChip');
    if (cloudChip) cloudChip.textContent = '‚òÅÔ∏è Cloud: Off';
  }
})();
firebaseReady = true;  // not: let firebaseReady = true;
db = firebase.firestore();
myUid = u ? u.uid : null;

(function initFirebase(){
    try {
    firebase.initializeApp(FB_CONFIG);
    const db = firebase.firestore();
    firebase.auth().signInAnonymously();
    firebase.auth().onAuthStateChanged(u => { myUid = u ? u.uid : null; });
    firebaseReady = true;
  } catch (e) {
    firebaseReady = false;
  }
})();

/******************** Data (questions) ********************/
const QUESTIONS = [
  {pct:90, q:'A 22-year-old twists an ankle. Which structure is injured in a <b>sprain</b>?', a:['Muscle belly','Tendon midsubstance','Ligament','Muscle‚Äìtendon junction'], c:2, note:'Sprain = ligament; strain = muscle/tendon unit.'},
  {pct:85, q:'Ottawa Ankle Rules: Which scenario <b>requires</b> an ankle X-ray?', a:['Lateral ankle pain; tender over ATFL; walks 4 steps unaided','Medial ankle pain; <b>posterior</b> edge tenderness at medial malleolus; can‚Äôt take 4 steps','Dorsal midfoot pain; base of 5th met tenderness; walks 4 steps','Lateral ankle pain; swelling only; wants reassurance'], c:1, note:'Pain in malleolar zone + posterior edge/tip malleolar tenderness or inability to bear weight ‚Üí X‚Äëray.'},
  {pct:80, q:'Ottawa Knee Rules: Which <b>single</b> finding mandates knee X-ray?', a:['Age 48 with diffuse tenderness, walks 4 steps','Unable to flex to 90¬∞ after a fall','Mild swelling after a 10 km run','Patellar tendon tenderness but full function'], c:1, note:'Any inability to flex to 90¬∞, age ‚â•55, isolated patellar tenderness, head of fibula tenderness, or inability to weight-bear ‚Üí X‚Äëray.'},
  {pct:70, q:'Acute nonspecific low back pain (no red flags). Best initial management?', a:['Two days bed rest','Keep active with simple analgesia ¬± NSAIDs','Immediate MRI','Opioids first-line for 72 h'], c:1, note:'Stay active; simple analgesia/NSAIDs; avoid bed rest and routine imaging without red flags.'},
  {pct:60, q:'Early ACL injury: which exam is <b>most sensitive</b>?', a:['Anterior drawer','Pivot‚Äìshift','Lachman test','Apley‚Äôs test'], c:2, note:'Lachman is most sensitive early for ACL insufficiency.'},
  {pct:50, q:'Adhesive capsulitis: which movement is <b>most limited</b> (passive and active)?', a:['Internal rotation','External rotation','Abduction','Flexion'], c:1, note:'Frozen shoulder typically shows marked loss of external rotation; passive = active restriction.'},
  {pct:40, q:'Suspected Achilles rupture: which finding most strongly supports the diagnosis?', a:['Pain on heel raise but normal push-off','Positive Thompson/Simmonds test','Diffuse calf tenderness only','Pain improves with walking'], c:1, note:'Absent plantarflexion on calf squeeze strongly suggests rupture.'},
  {pct:30, q:'Which cluster most strongly suggests <b>cauda equina syndrome</b>?', a:['Severe unilateral sciatica, positive SLR','Urinary <b>retention</b>, saddle anaesthesia, bilateral leg weakness','Night pain relieved by movement','Reduced ankle reflex on one side only'], c:1, note:'Urinary retention + saddle anaesthesia + bilateral neuro signs = red flag for CES.'},
  {pct:25, q:'Wrist/hand paraesthesia: which feature points to <b>carpal tunnel</b> rather than C6 radiculopathy?', a:['Neck pain radiating to thumb','Weak wrist extension','Nocturnal symptoms in digits 1‚Äì3 eased by ‚Äúflicking‚Äù the hand','Diminished biceps reflex'], c:2, note:'Nocturnal paresthesia in digits 1‚Äì3 with a ‚Äúflick sign‚Äù favors CTS; C6 radic often has neck pain, biceps reflex changes, wrist‚Äëextensor weakness.'},
  {pct:20, q:'An overweight 13‚Äëyear‚Äëold presents with knee pain, limp, and markedly reduced <b>hip internal rotation</b>. Most likely diagnosis?', a:['Osgood‚ÄìSchlatter disease','Slipped capital femoral epiphysis (SCFE)','Patellofemoral pain syndrome','Quadriceps strain'], c:1, note:'SCFE often refers pain to the knee; limited hip internal rotation is classic.'},
  {pct:15, q:'Medial tibial pain in a runner: which finding best differentiates <b>tibial stress fracture</b> from medial tibial stress syndrome?', a:['Pain only at the start of runs','Diffuse tenderness over >5 cm of tibia','<b>Focal</b> bony tenderness over <5 cm and pain on hop test','Relief with arch supports'], c:2, note:'Focal bony tenderness (<5 cm) and painful hop test ‚Üí stress fracture; MTSS is diffuse (>5 cm).'},
  {pct:10, q:'CRPS (Budapest criteria). Which is <b>least</b> characteristic?', a:['Allodynia/hyperalgesia','Temperature or colour asymmetry','Joint effusion with purulent aspirate','Edema/sudomotor changes and trophic change'], c:2, note:'Purulent joint effusion suggests septic arthritis, not CRPS.'},
  {pct:5, q:'Post‚Äëreduction anterior shoulder dislocation: numb ‚Äúregimental badge‚Äù area and weak shoulder abduction. Most likely nerve injury?', a:['Musculocutaneous','Axillary','Radial','Suprascapular'], c:1, note:'Axillary nerve ‚Üí deltoid weakness + ‚Äúregimental badge‚Äù numbness.'},
  {pct:3, q:'Thumb injury after ski fall: marked valgus laxity at MCP and a <b>palpable tender lump proximally</b> at the ulnar side. Best interpretation?', a:['Simple UCL sprain‚Äîthumb spica only','Volar plate sprain‚Äîbuddy tape','Stener lesion‚Äîsurgical referral indicated','First CMC OA flare‚ÄîNSAIDs and activity mod'], c:2, note:'Stener lesion: UCL torn with adductor aponeurosis interposition ‚Üí palpable lump; needs surgery.'},
  {pct:1, q:'Elbow trauma in a child with supracondylar fracture features. They ‚Äúcan‚Äôt make the OK sign‚Äù (weak thumb IP and index DIP flexion) but wrist extension is fine. Which nerve is most likely affected?', a:['Radial nerve','Posterior interosseous nerve','Anterior interosseous branch of median nerve','Ulnar nerve'], c:2, note:'AIN palsy (median branch): FPL + FDP (index) weakness ‚Üí ‚ÄúOK sign‚Äù deficit; radial/PIN spare wrist extension.'}
];

/******************** State ********************/
const state = {
  mode: 'local', // 'local' | 'host' | 'player'
  idx: -1,
  selected: null,
  revealed: false,
  sound: false,
  players: [], // local roster [{id,name,passes,active}]
  cloud: { room:null, unsubRoom:null, unsubCounts:null, unsubPlayers:null },
};

/******************** Elements ********************/
const ladderEl = document.getElementById('ladder');
const qTextEl = document.getElementById('qText');
const qPctEl  = document.getElementById('qPct');
const optsEl  = document.getElementById('opts');
const noteEl  = document.getElementById('note');
const statusEl= document.getElementById('status');
const roomBadge=document.getElementById('roomBadge');
const roleBadge=document.getElementById('roleBadge');

const startBtn= document.getElementById('startBtn');
const revealBtn=document.getElementById('revealBtn');
const nextBtn = document.getElementById('nextBtn');
const lockBtn = document.getElementById('lockBtn');
const soundChip=document.getElementById('soundChip');
const cloudChip=document.getElementById('cloudChip');

const nameInput=document.getElementById('nameInput');
const addBtn=document.getElementById('addBtn');
const rosterEl=document.getElementById('roster');
const pCountEl=document.getElementById('pCount');
const clearRosterBtn=document.getElementById('clearRosterBtn');
const allPassBtn=document.getElementById('allPassBtn');
const reviveBtn=document.getElementById('reviveBtn');

// Tabs
const tabLocal=document.getElementById('tabLocal');
const tabHost=document.getElementById('tabHost');
const tabPlayer=document.getElementById('tabPlayer');

// Host panel
const hostPanel=document.getElementById('hostPanel');
const hostNameInput=document.getElementById('hostNameInput');
const createRoomBtn=document.getElementById('createRoomBtn');
const closeRoomBtn=document.getElementById('closeRoomBtn');
const roomInfo=document.getElementById('roomInfo');
const roomCodeEl=document.getElementById('roomCode');
const shareLinkEl=document.getElementById('shareLink');
const copyLinkBtn=document.getElementById('copyLinkBtn');
const countsBox=document.getElementById('counts');
const fa=document.getElementById('fa'), fb=document.getElementById('fb'), fc=document.getElementById('fc'), fd=document.getElementById('fd');
const ca=document.getElementById('ca'), cb=document.getElementById('cb'), cc=document.getElementById('cc'), cd=document.getElementById('cd');
const hostHint=document.getElementById('hostHint');

// Player panel
const playerPanel=document.getElementById('playerPanel');
const playerName=document.getElementById('playerName');
const joinCode=document.getElementById('joinCode');
const joinBtn=document.getElementById('joinBtn');
const playerHint=document.getElementById('playerHint');

// Multi panel wrapper (for show/hide)
const mpanel=document.getElementById('mpanel');

/******************** Audio (no external files) ********************/
let AC=null; function ensureAC(){ if(!state.sound) return; if(!AC){ try{ AC = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
function tone(freq=440, dur=0.08){ if(!state.sound||!AC) return; const o=AC.createOscillator(), g=AC.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(AC.destination); const t=AC.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.2,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.start(t); o.stop(t+dur+0.01);
}
function sfxCorrect(){ ensureAC(); [523,659,784].forEach((f,i)=>setTimeout(()=>tone(f,0.09),i*90)); }
function sfxWrong(){ ensureAC(); [220,180,150].forEach((f,i)=>setTimeout(()=>tone(f,0.12),i*110)); }
function sfxTick(){ ensureAC(); tone(420,0.05); }

/******************** Helpers ********************/
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function setStatus(html){ statusEl.innerHTML = html; }
function setRoleBadge(){ roleBadge.textContent = state.mode.charAt(0).toUpperCase()+state.mode.slice(1); }
function setCloudChip(){ cloudChip.textContent = firebaseReady? '‚òÅÔ∏è Cloud: On' : '‚òÅÔ∏è Cloud: Off'; }
function byId(id){ return document.getElementById(id); }

/******************** Ladder ********************/
function renderLadder(){
  ladderEl.innerHTML = '';
  QUESTIONS.forEach((q,i)=>{
    const div=document.createElement('div'); div.className='step'+(i<state.idx?' done':'')+(i===state.idx?' current':'');
    const left=document.createElement('div'); left.innerHTML = `<span class="pct">${q.pct}%</span>`;
    const right=document.createElement('div'); right.className='small muted'; right.textContent = i<state.idx? '‚úî' : (i===state.idx? 'Now' : 'Up next');
    div.append(left,right); ladderEl.appendChild(div);
  });
}
function buildEmptyLadder(){ ladderEl.innerHTML=''; QUESTIONS.forEach(()=>{ const d=document.createElement('div'); d.className='step'; d.innerHTML='<span class="pct">‚Äî%</span><span class="small muted">‚Äî</span>'; ladderEl.appendChild(d); }); }

/******************** Core rendering ********************/
function showQuestion(){
  if(state.idx<0){ qPctEl.textContent='‚Äî%'; qTextEl.innerHTML = msgIntro(); optsEl.innerHTML=''; noteEl.hidden=true; noteEl.innerHTML=''; renderLadder(); return; }
  const q = QUESTIONS[state.idx];
  qPctEl.textContent = q.pct + '%';
  qTextEl.innerHTML = q.q;
  noteEl.hidden = true; noteEl.innerHTML = '';
  optsEl.innerHTML = '';
  ['A','B','C','D'].forEach((label,ix)=>{
    const b=document.createElement('button'); b.className='opt'; b.dataset.idx=ix;
    b.innerHTML = `<span class="k">${label}</span> <span>${q.a[ix]}</span>`;
    b.onclick=()=>select(ix);
    optsEl.appendChild(b);
  });
  state.selected=null; state.revealed=false;
  if(state.mode==='player') { lockBtn.disabled=true; revealBtn.disabled=true; nextBtn.disabled=true; startBtn.disabled=true; }
  else { revealBtn.disabled = true; nextBtn.disabled=true; lockBtn.disabled=true; }
  setStatus('Pick an answer, then <b>Lock In</b> (or host reveal if synced).');
  renderLadder();
}
function msgIntro(){
  return 'Choose a mode above. <b>Local</b> runs on one screen. <b>Host</b> creates a room; <b>Player</b> joins from another device.';
}

/******************** Local game flow ********************/
function select(ix){ if(state.revealed) return; state.selected = ix; updateSelection(); sfxTick(); if(state.mode==='player') submitAnswer(ix); lockBtn.disabled=false; setStatus('Answer selected. <b>Lock In</b> to proceed.'); }
function updateSelection(){ [...optsEl.children].forEach(btn=>{ btn.classList.toggle('selected', Number(btn.dataset.idx)===state.selected); }); }
function lockIn(){ if(state.selected==null) return; revealBtn.disabled=false; lockBtn.disabled=true; setStatus('Ready to reveal. (<span class="kb">R</span>)'); }
function revealLocal(){ if(state.revealed||state.selected==null) return; const q=QUESTIONS[state.idx];
  const correct = q.c;
  [...optsEl.children].forEach(btn=>{
    const ix=Number(btn.dataset.idx);
    btn.disabled=true;
    if(ix===correct) btn.classList.add('correct');
    if(ix===state.selected && ix!==correct) btn.classList.add('wrong');
  });
  noteEl.hidden=false; noteEl.innerHTML = q.note;
  state.revealed=true; nextBtn.disabled=false; revealBtn.disabled=true;
  setStatus( (state.selected===q.c)? '<b>Correct!</b>' : '<b>Wrong.</b>' );
  (state.selected===q.c? sfxCorrect(): sfxWrong());
}
function nextLocal(){ if(!state.revealed) return; if(state.idx>=QUESTIONS.length-1){ endGame(); return; } state.idx++; showQuestion(); }
function startLocal(){ state.idx=0; showQuestion(); startBtn.disabled=true; }
function resetLocal(){ state.idx=-1; state.selected=null; state.revealed=false; startBtn.disabled=false; revealBtn.disabled=true; nextBtn.disabled=true; lockBtn.disabled=true;
  qPctEl.textContent='‚Äî%'; qTextEl.innerHTML=msgIntro(); optsEl.innerHTML=''; noteEl.hidden=true; noteEl.innerHTML=''; setStatus(''); renderLadder(); }
function endGame(){ setStatus('<b>1% question complete!</b> Congratulate your champions.'); qTextEl.innerHTML='üéâ You reached the 1% Club!'; optsEl.innerHTML=''; noteEl.hidden=true; revealBtn.disabled=true; nextBtn.disabled=true; lockBtn.disabled=true; }

/******************** Cloud (Firestore) ‚Äî room model ********************/
// rooms/{CODE}: { qIdx:number, revealed:boolean, createdAt, open:boolean }
// rooms/{CODE}/players/{uid}: { name, passes, active, joinedAt }
// rooms/{CODE}/answers/{qIdx_uid}: { qIdx, uid, choice, ts }
function randomCode(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }
function roomDoc(){
  if (!db || !state.cloud.room) { throw new Error('Room/DB not ready'); }
  return db.collection('rooms').doc(state.cloud.room);
}

function answersCol(){ return roomDoc().collection('answers'); }
function playersCol(){ return roomDoc().collection('players'); }

async function createRoom(){
  if (!firebaseReady || !db) return false;
  const code = Math.random().toString(36).slice(2,8).toUpperCase();
  await db.collection('rooms').doc(code).set({
    qIdx: 0,
    revealed: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    open: true,
    hostUid: myUid || null
  });
  state.cloud.room = code;
  onRoomChanged();
  return true;
}

async function closeRoom(){ if(!state.cloud.room) return; await roomDoc().update({ open:false }); unsubscribeCloud(); state.cloud.room=null; onRoomChanged(); }

async function joinRoom(code, name){ if(!firebaseReady) return alert('Cloud sync is off.'); if(!code) return alert('Enter a room code');
  state.cloud.room = code.toUpperCase(); onRoomChanged();
  await playersCol().doc(myUid||'anon').set({ name: name||'Player', passes:3, active:true, joinedAt:firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
}

function subscribeRoom(){ if(!state.cloud.room||!firebaseReady) return; // room doc
  if(state.cloud.unsubRoom) state.cloud.unsubRoom();
  state.cloud.unsubRoom = roomDoc().onSnapshot(snap=>{
    const r=snap.data(); if(!r) return;
    const wasIdx = state.idx; state.idx = r.qIdx; state.revealed = r.revealed;
    // re-render when question or reveal changes
    if(wasIdx!==state.idx) { showQuestion(); watchCounts(); }
    if(state.revealed){ revealPaintOnly(); } // paint correctness without allowing next on players
    renderLadder();
  });
  // players roster
  if(state.cloud.unsubPlayers) state.cloud.unsubPlayers();
  state.cloud.unsubPlayers = playersCol().onSnapshot(snap=>{
    state.players = []; snap.forEach(doc=>{ const p=doc.data(); state.players.push({ id:doc.id, name:p.name||'Player', passes:p.passes??3, active:p.active??true }); });
    renderRoster();
  });
  // counts for current q
  watchCounts();
}
function unsubscribeCloud(){ if(state.cloud.unsubRoom){ state.cloud.unsubRoom(); state.cloud.unsubRoom=null; } if(state.cloud.unsubCounts){ state.cloud.unsubCounts(); state.cloud.unsubCounts=null; } if(state.cloud.unsubPlayers){ state.cloud.unsubPlayers(); state.cloud.unsubPlayers=null; } }

function watchCounts(){ if(!firebaseReady||!state.cloud.room) return; if(state.cloud.unsubCounts) state.cloud.unsubCounts();
  state.cloud.unsubCounts = answersCol().where('qIdx','==',state.idx).onSnapshot(snap=>{
    const counts=[0,0,0,0]; snap.forEach(d=>{ const ch=d.data().choice; if(ch>=0&&ch<4) counts[ch]++; });
    renderCounts(counts);
  });
}
function renderCounts([A,B,C,D]){
  const total = Math.max(1, A+B+C+D);
  countsBox.hidden = false;
  fa.style.width = (A*100/total)+'%'; fb.style.width = (B*100/total)+'%'; fc.style.width = (C*100/total)+'%'; fd.style.width = (D*100/total)+'%';
  ca.textContent=A; cb.textContent=B; cc.textContent=C; cd.textContent=D;
}

async function hostReveal(){ if(!firebaseReady||!state.cloud.room) return revealLocal(); await roomDoc().update({ revealed:true }); }
async function hostNext(){ if(!firebaseReady||!state.cloud.room) return nextLocal(); const next = Math.min(state.idx+1, QUESTIONS.length-1); await roomDoc().update({ qIdx: next, revealed:false }); }

async function submitAnswer(choice){ if(!firebaseReady||!state.cloud.room||myUid==null) return; const id = `${state.idx}_${myUid}`; await answersCol().doc(id).set({ qIdx:state.idx, uid:myUid, choice, ts: firebase.firestore.FieldValue.serverTimestamp() }); }

function revealPaintOnly(){ // Mark correct/wrong based on last local selection if available
  const q=QUESTIONS[state.idx];
  [...optsEl.children].forEach(btn=>{
    const ix=Number(btn.dataset.idx); btn.disabled=true; if(ix===q.c) btn.classList.add('correct');
    if(ix===state.selected && ix!==q.c) btn.classList.add('wrong');
  });
  noteEl.hidden=false; noteEl.innerHTML = q.note;
}

/******************** Roster (local + cloud) ********************/
function loadRosterLocal(){ try{ const raw=localStorage.getItem('msk1pct_roster'); state.players = raw? JSON.parse(raw): []; }catch(e){ state.players=[]; } renderRoster(); }
function saveRosterLocal(){ localStorage.setItem('msk1pct_roster', JSON.stringify(state.players)); }
function addNamesLocal(names){ names.split(',').map(s=>s.trim()).filter(Boolean).forEach(n=>{ state.players.push({id:crypto.randomUUID(), name:n, passes:3, active:true}); }); saveRosterLocal(); renderRoster(); nameInput.value=''; }
function renderRoster(){ rosterEl.innerHTML=''; const active=state.players.filter(p=>p.active).length; pCountEl.textContent = state.players.length? `¬∑ ${active}/${state.players.length} active` : '';
  state.players.forEach(p=>{
    const row=document.createElement('div'); row.className='row'; row.style.margin='6px 0';
    const left=document.createElement('div'); left.innerHTML = `<b>${escapeHtml(p.name)}</b> <span class="small muted">${p.active?'¬∑ In':'¬∑ Out'}</span>`;
    const passes=document.createElement('div'); passes.className='pill'; passes.textContent = `Passes: ${p.passes}`;
    const passBtn=document.createElement('button'); passBtn.textContent='Pass'; passBtn.onclick=async()=>{
      if(p.passes>0) p.passes--; if(state.mode==='host'&&firebaseReady&&state.cloud.room){ await playersCol().doc(p.id).set({ passes:p.passes },{merge:true}); } else { saveRosterLocal(); } renderRoster(); };
    const failBtn=document.createElement('button'); failBtn.textContent=p.active?'Fail':'Undo'; failBtn.onclick=async()=>{
      p.active=!p.active; if(state.mode==='host'&&firebaseReady&&state.cloud.room){ await playersCol().doc(p.id).set({ active:p.active },{merge:true}); } else { saveRosterLocal(); } renderRoster(); };
    row.append(left, passes, passBtn, failBtn); rosterEl.appendChild(row);
  });
}
function clearRoster(){ if(confirm('Clear all players?')){ state.players=[]; if(state.mode==='host'&&firebaseReady&&state.cloud.room){ /* host clearing cloud roster intentionally left manual */ } else { saveRosterLocal(); } renderRoster(); } }
function giveAllPass(){ state.players.forEach(p=>{ if(p.active) p.passes = Math.max(0, p.passes-1); }); if(state.mode==='host'&&firebaseReady&&state.cloud.room){ state.players.forEach(async p=>{ await playersCol().doc(p.id).set({ passes:p.passes },{merge:true}); }); } else { saveRosterLocal(); } renderRoster(); }
function reviveAll(){ state.players.forEach(p=> p.active=true); if(state.mode==='host'&&firebaseReady&&state.cloud.room){ state.players.forEach(async p=>{ await playersCol().doc(p.id).set({ active:true },{merge:true}); }); } else { saveRosterLocal(); } renderRoster(); }

/******************** Events & UI wiring ********************/
startBtn.onclick = ()=> state.mode==='local'? startLocal() : (state.mode==='host'? hostNext() : null);
revealBtn.onclick = ()=> state.mode==='host'? hostReveal() : revealLocal();
nextBtn.onclick = ()=> state.mode==='host'? hostNext() : nextLocal();
lockBtn.onclick= lockIn;

soundChip.onclick = ()=>{ state.sound=!state.sound; soundChip.textContent = state.sound? 'üîä Sound: On' : 'üîà Sound: Off'; ensureAC(); if(state.sound) sfxTick(); };

addBtn.onclick = ()=> state.mode==='local'? addNamesLocal(nameInput.value) : alert('In Host mode, roster fills from players joining the room.');
clearRosterBtn.onclick = clearRoster; allPassBtn.onclick = giveAllPass; reviveBtn.onclick = reviveAll;

createRoomBtn.onclick = async () => {
  if (!firebaseReady || !db) { alert('Cloud sync is OFF ‚Äî check FB_CONFIG and authorised domain.'); return; }
  const ok = await createRoom();            // make createRoom return true/false
  if (ok) { subscribeRoom(); paintRoomUi(); }
};

closeRoomBtn.onclick = async () => {
  if (!firebaseReady || !db || !state.cloud.room) return;
  await closeRoom(); paintRoomUi();
};

copyLinkBtn.onclick = () => {
  shareLinkEl.select();
  document.execCommand('copy');
  setStatus('Link copied to clipboard.');
};

joinBtn.onclick = async()=>{ await joinRoom(joinCode.value, playerName.value||'Player'); subscribeRoom(); paintRoomUi(); };

// Keyboard shortcuts
window.addEventListener('keydown', (e)=>{
  if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  const k=e.key.toLowerCase();
  if(k==='a') select(0);
  else if(k==='b') select(1);
  else if(k==='c') select(2);
  else if(k==='d') select(3);
  else if(k==='r') (state.mode==='host'? hostReveal(): revealLocal());
  else if(k==='n') (state.mode==='host'? hostNext(): nextLocal());
  else if(k==='s') (state.mode==='local'? startLocal(): null);
});

// Tabs switching
function setActiveTab(which){ [tabLocal,tabHost,tabPlayer].forEach(b=>b.classList.remove('active')); if(which==='local') tabLocal.classList.add('active'); if(which==='host') tabHost.classList.add('active'); if(which==='player') tabPlayer.classList.add('active'); }
function switchMode(which){ state.mode=which; setActiveTab(which); setRoleBadge();
  hostPanel.hidden = which!=='host'; playerPanel.hidden = which!=='player'; mpanel.style.display = (which==='local')? 'none':'grid';
  // Buttons availability
  startBtn.disabled = (which!=='local'); revealBtn.disabled=(which==='player'); nextBtn.disabled=(which!=='local'); lockBtn.disabled=true;
  // Roster source
  if(which==='local'){ loadRosterLocal(); } else { state.players=[]; renderRoster(); }
  showQuestion(); paintRoomUi(); }

[tabLocal,tabHost,tabPlayer].forEach(b=> b.onclick = ()=> switchMode(b.id==='tabLocal'?'local':(b.id==='tabHost'?'host':'player')));

/******************** Paint cloud UI ********************/
function onRoomChanged(){ paintRoomUi(); if(state.cloud.room){ subscribeRoom(); } }
function paintRoomUi(){ setCloudChip(); const hasRoom = !!state.cloud.room; roomBadge.hidden = !hasRoom; roomBadge.textContent = 'Room: '+(state.cloud.room||'‚Äî');
  if(state.mode==='host'){
    closeRoomBtn.disabled = !hasRoom; createRoomBtn.disabled = !firebaseReady || hasRoom;
    roomInfo.hidden = !hasRoom; countsBox.hidden = !hasRoom; hostHint.hidden = hasRoom;
    if(hasRoom){ const url = new URL(window.location.href); url.searchParams.set('room', state.cloud.room); shareLinkEl.value = url.toString(); roomCodeEl.textContent = state.cloud.room; }
    // Host can drive start/reveal/next only when room exists
    startBtn.disabled=false; revealBtn.disabled=false; nextBtn.disabled=false;
  } else if(state.mode==='player'){
    joinBtn.disabled = !firebaseReady; playerHint.textContent = firebaseReady? 'Enter code + name, then join.' : 'Cloud is Off ‚Äî add Firebase config in the file to enable joining rooms.';
    // players do not control these buttons
    startBtn.disabled=true; revealBtn.disabled=true; nextBtn.disabled=true;
  } else { // local
    roomInfo.hidden = true; countsBox.hidden = true; roomBadge.hidden = true;
  }
}

/******************** Init ********************/
function init(){ setCloudChip(); setRoleBadge(); buildEmptyLadder(); resetLocal();
  // Auto-join if ?room=CODE is present and we are in Player tab
  const params = new URLSearchParams(location.search); const pre = (params.get('room')||'').toUpperCase();
  if(pre){ switchMode('player'); joinCode.value = pre; }
}
init();
</script>
</body>
</html>
